<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPOIRD TACTICAL ANALYZER - MAIL EDITION</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b0f19; --card: #161e2d; --accent: #00f2ff;
            --text: #e2e8f0; --win: #10b981; --loss: #f43f5e; --gray: #64748b; --warning: #fbbf24;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Header */
        .header-box { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid var(--gray); margin-bottom: 10px; text-align: center; }
        #timer-display { font-size: 3.5rem; font-weight: 900; color: white; display: block; }
        .period-label { color: var(--accent); font-weight: 900; letter-spacing: 2px; margin-bottom: 5px; }
        
        /* Possession */
        .possession-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .pos-btn { padding: 20px; border: none; border-radius: 12px; color: white; font-weight: 800; opacity: 0.2; transition: 0.3s; }
        .pos-btn.active { opacity: 1; box-shadow: 0 0 20px var(--accent); transform: scale(1.02); }

        /* KPI */
        .kpi-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #2d3748; }
        .kpi-value { font-size: 2rem; font-weight: 900; color: var(--accent); display: block; }
        .kpi-label { font-size: 0.7rem; color: var(--gray); text-transform: uppercase; }

        /* Controls */
        .control-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn-main-sm { background: #334155; border: none; color: white; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 0.7rem; cursor: pointer; }
        .btn-reset { background: #450a0a; color: #f87171; border: 1px solid #7f1d1d; }

        /* Log */
        .log-container { background: #0f172a; border: 1px solid #334155; border-radius: 12px; height: 120px; overflow-y: auto; padding: 10px; margin-bottom: 15px; font-family: monospace; font-size: 0.75rem; }
        .log-entry { border-bottom: 1px solid #1e293b; padding: 4px 0; display: flex; gap: 10px; }

        /* Matrix */
        .matrix { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .macro-btn { background: var(--card); border: 1px solid #2d3748; border-radius: 15px; padding: 25px 5px; text-align: center; cursor: pointer; }
        .macro-title { font-weight: 900; font-size: 0.8rem; color: #fff; text-transform: uppercase; }
        .macro-count { font-size: 0.65rem; color: var(--accent); display: block; margin-top: 5px; }

        /* Modal */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .micro-group { background: #1e293b; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 4px solid var(--accent); }
        .micro-label { display: block; font-size: 0.75rem; font-weight: 800; margin-bottom: 10px; color: var(--gray); text-transform: uppercase; }
        .btn-row { display: flex; flex-wrap: wrap; gap: 6px; }
        .btn-action { flex: 1; min-width: 120px; padding: 14px 5px; border: none; border-radius: 6px; background: #334155; color: white; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .btn-close { background: var(--loss); color: white; padding: 18px; border: none; border-radius: 10px; font-weight: 900; margin-top: 10px; }

        /* Report */
        .report-section { background: #fff; border-radius: 20px; padding: 15px; margin-top: 20px; display: none; }
        .action-btn { background: var(--accent); color: #000; padding: 20px; border-radius: 15px; border: none; font-weight: 900; width: 100%; margin: 8px 0; cursor: pointer; font-size: 1rem; }
        .mail-btn { background: #ea4335; color: white; }
    </style>
</head>
<body>

    <div class="header-box">
        <div class="period-label" id="period-display">1Â° TEMPO</div>
        <span id="timer-display">00:00</span>
        
        <div class="possession-container">
            <button id="posA" class="pos-btn" style="background: var(--win)" onclick="setPoss('A')">NOI: <span id="percA">50%</span></button>
            <button id="posB" class="pos-btn" style="background: var(--loss)" onclick="setPoss('B')">LORO: <span id="percB">50%</span></button>
        </div>

        <div class="control-btns">
            <button id="startBtn" class="btn-main-sm" onclick="toggleTimer()">START</button>
            <button id="nextPeriodBtn" class="btn-main-sm" onclick="switchToSecondPeriod()">NEXT TEMPO</button>
            <button class="btn-main-sm btn-reset" onclick="resetAllData()">RESET</button>
        </div>
    </div>

    <div class="kpi-container">
        <div class="kpi-card"><span class="kpi-value" id="xg-prod">0.00</span><span class="kpi-label">Punti Prodotti</span></div>
        <div class="kpi-card"><span class="kpi-value" id="xg-conc">0.00</span><span class="kpi-label">Punti Subiti</span></div>
    </div>

    <div class="log-container" id="main-log"></div>

    <div class="matrix">
        <div class="macro-btn" onclick="openMacro('FINALIZZAZIONE')"><span class="macro-title">Finalizzazione</span><span class="macro-count" id="count-FINALIZZAZIONE">0</span></div>
        <div class="macro-btn" onclick="openMacro('PALLA-INATTIVA')"><span class="macro-title">Palla Inattiva</span><span class="macro-count" id="count-PALLA-INATTIVA">0</span></div>
        <div class="macro-btn" onclick="openMacro('TRANSIZIONI-OFFENSIVE')"><span class="macro-title">Transizioni OFF</span><span class="macro-count" id="count-TRANSIZIONI-OFFENSIVE">0</span></div>
        <div class="macro-btn" onclick="openMacro('CONTRASTO-RECUPERO')"><span class="macro-title">Contrasto/Rec</span><span class="macro-count" id="count-CONTRASTO-RECUPERO">0</span></div>
        <div class="macro-btn" onclick="openMacro('PROGRESSIONE')"><span class="macro-title">Progressione</span><span class="macro-count" id="count-PROGRESSIONE">0</span></div>
        <div class="macro-btn" onclick="openMacro('TRANSIZIONI-DIFENSIVE')"><span class="macro-title">Transizioni DIF</span><span class="macro-count" id="count-TRANSIZIONI-DIFENSIVE">0</span></div>
    </div>

    <button class="action-btn" onclick="showCharts()">ðŸ“Š MOSTRA GRAFICI</button>
    <button class="action-btn mail-btn" onclick="sendReportByMail()">ðŸ“§ INVIA REPORT A SCURATTI</button>

    <div id="chart-section" class="report-section">
        <canvas id="radarChart"></canvas>
    </div>

    <div id="modal-overlay">
        <h2 id="modal-title" style="color:var(--accent); text-align:center; text-transform:uppercase;"></h2>
        <div id="modal-body"></div>
        <button class="btn-close" onclick="closeModal()">CHIUDI</button>
    </div>

    <script>
        let seconds = 0, timeN = 0, timeL = 0, activeP = null, timerIdx = null, running = false, period = 1;
        let matchData = { t1: { ptN: 0, ptL: 0, pos: "50/50" }, t2: { ptN: 0, ptL: 0, pos: "50/50" } };
        let stats = {
            ptN: 0, ptL: 0,
            counts: { "FINALIZZAZIONE":0, "PALLA-INATTIVA":0, "TRANSIZIONI-OFFENSIVE":0, "CONTRASTO-RECUPERO":0, "PROGRESSIONE":0, "TRANSIZIONI-DIFENSIVE":0 },
            micro: {}
        };

        function toggleTimer() {
            if(!running) {
                running = true; document.getElementById('startBtn').innerText = "PAUSA";
                timerIdx = setInterval(() => { seconds++; if(activeP==='A') timeN++; if(activeP==='B') timeL++; updateUI(); }, 1000);
            } else {
                running = false; clearInterval(timerIdx); document.getElementById('startBtn').innerText = "RIPRENDI";
            }
        }

        function updateUI() {
            const m = Math.floor(seconds/60).toString().padStart(2,'0'), s = (seconds%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
            let tot = timeN + timeL || 1;
            document.getElementById('percA').innerText = Math.round((timeN/tot)*100)+'%';
            document.getElementById('percB').innerText = Math.round((timeL/tot)*100)+'%';
        }

        function setPoss(t) { activeP = t; document.getElementById('posA').classList.toggle('active', t==='A'); document.getElementById('posB').classList.toggle('active', t==='B'); }

        function openMacro(name) {
            const body = document.getElementById('modal-body');
            document.getElementById('modal-title').innerText = name.replace(/-/g, ' ');
            body.innerHTML = '';
            let h = '';

            if(name === 'FINALIZZAZIONE') {
                h = group("TIRI", [
                    btn('xgN', 0.20, name, 'Tiro in Porta'), btn('xgN', 0.10, name, 'Tiro Fuori'), btn('xgN', 0.05, name, 'Tiro Bloccato'),
                    btn('xgN', 0.15, name, 'Fuori Area'), btn('xgN', 0.40, name, 'Dentro Area'), btn('xgN', 1.0, name, 'GOL', '#10b981')
                ]) + group("CREAZIONE", [
                    btn('xgN', 0.30, name, 'Assist'), btn('xgN', 0.15, name, 'Key Pass'), btn('xgN', 0.10, name, 'Cross OK')
                ]);
            } else if(name === 'PROGRESSIONE') {
                h = group("DRIBBLING ZONALE", [
                    btn('xgN', 0.05, name, 'Dribbling 0-25m'), btn('xgN', 0.15, name, 'Dribbling 26-50m'), 
                    btn('xgN', 0.25, name, 'Dribbling 51-75m'), btn('xgN', 0.40, name, 'Dribbling 76-100m')
                ]) + group("MANOVRA", [
                    btn('xgN', 0.20, name, 'Pass. ProfonditÃ '), btn(null, 0, name, 'Dribbling Perso')
                ]);
            } else if(name === 'PALLA-INATTIVA') {
                h = group("SITUAZIONI", [
                    btn('xgN', 0.10, name, 'Corner Pro'), btn('xgL', 0.10, name, 'Corner Contro'), btn('xgN', 0.30, name, 'Punizione'), btn('xgN', 0.50, name, 'Gol/Tiro Inattiva')
                ]);
            } else if(name === 'TRANSIZIONI-OFFENSIVE') {
                h = group("ATTACCO", [ btn('xgN', 0.40, name, 'Contropiede OK'), btn('xgN', 0.20, name, 'Attacco Diretto') ]);
            } else if(name === 'CONTRASTO-RECUPERO') {
                h = group("DIFESA", [ btn('xgN', 0.05, name, 'Contrasto Vinto'), btn('xgN', 0.10, name, 'Intercettazione'), btn('xgN', 0.05, name, 'Duello Aereo') ]);
            } else if(name === 'TRANSIZIONI-DIFENSIVE') {
                h = group("SUBITE", [ btn('xgL', 0.40, name, 'Contropiede Subito'), btn('xgL', 0.50, name, 'Persa Critica'), btn('xgL', 0.10, name, 'Fallo Tattico') ]);
            }

            body.innerHTML = h;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function group(label, btns) { return `<div class="micro-group"><span class="micro-label">${label}</span><div class="btn-row">${btns.join('')}</div></div>`; }
        function btn(type, val, macro, label, color) { 
            let style = color ? `style="background:${color}"` : '';
            return `<button class="btn-action" ${style} onclick="logE('${type}', ${val}, '${macro}', '${label}')">${label}</button>`; 
        }

        function logE(type, val, macro, label) {
            if(type === 'xgN') stats.ptN += val;
            if(type === 'xgL') stats.ptL += val;
            stats.counts[macro]++;
            stats.micro[label] = (stats.micro[label] || 0) + 1;
            document.getElementById('xg-prod').innerText = stats.ptN.toFixed(2);
            document.getElementById('xg-conc').innerText = stats.ptL.toFixed(2);
            document.getElementById(`count-${macro}`).innerText = stats.counts[macro];
            const ts = document.getElementById('timer-display').innerText;
            document.getElementById('main-log').innerHTML = `<div class="log-entry"><span style="color:var(--accent)">[${ts}]</span><span>${label}</span></div>` + document.getElementById('main-log').innerHTML;
            closeModal();
        }

        function switchToSecondPeriod() {
            if(period === 1 && confirm("Passare al Secondo Tempo?")) {
                matchData.t1 = { ptN: stats.ptN.toFixed(2), ptL: stats.ptL.toFixed(2), pos: document.getElementById('percA').innerText + "/" + document.getElementById('percB').innerText };
                period = 2; seconds = 0; timeN = 0; timeL = 0; stats.ptN = 0; stats.ptL = 0;
                document.getElementById('period-display').innerText = "2Â° TEMPO";
                updateUI();
                document.getElementById('main-log').innerHTML = `<strong>--- FINE PRIMO TEMPO ---</strong>` + document.getElementById('main-log').innerHTML;
            }
        }

        function sendReportByMail() {
            let cp = period === 1 ? "t1" : "t2";
            matchData[cp] = { ptN: stats.ptN.toFixed(2), ptL: stats.ptL.toFixed(2), pos: document.getElementById('percA').innerText + "/" + document.getElementById('percB').innerText };
            
            const email = "scurattiandrea@gmail.com";
            const subject = "REPORT IPOIRD - " + new Date().toLocaleDateString();
            let body = `SINTESI MATCH\n\n1Â° TEMPO: Pt ${matchData.t1.ptN}/${matchData.t1.ptL} | Poss. ${matchData.t1.pos}\n`;
            if(period === 2) body += `2Â° TEMPO: Pt ${matchData.t2.ptN}/${matchData.t2.ptL} | Poss. ${matchData.t2.pos}\n`;
            body += `\nVOLUME MACRO:\n` + JSON.stringify(stats.counts, null, 2);
            body += `\n\nDETTAGLIO MICRO:\n` + JSON.stringify(stats.micro, null, 2);
            
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function showCharts() {
            document.getElementById('chart-section').style.display = 'block';
            new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: {
                    labels: Object.keys(stats.counts),
                    datasets: [{ label: 'Volume Azioni', data: Object.values(stats.counts), backgroundColor: 'rgba(0, 242, 255, 0.2)', borderColor: '#00f2ff' }]
                },
                options: { scales: { r: { beginAtZero: true, grid: { color: '#334155' } } } }
            });
            window.scrollTo(0, document.body.scrollHeight);
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        function resetAllData() { if(confirm("Resettare tutto?")) location.reload(); }
    </script>
</body>
</html>
